<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Stroop (PL) — 10 trening + 50 test</title>
<style>
  html,body{height:100%}
  body{
    margin:0;
    background:#e9e9e9;   /* jasnoszare tło */
    color:#111;           /* ciemny tekst */
    font-family:'Calibri','Segoe UI',Roboto,sans-serif;
    display:flex;align-items:center;justify-content:center
  }
  #app{max-width:900px;padding:24px;text-align:center}
  h1,h2{margin:0 0 12px} p{line-height:1.5}
  .muted{color:#555}

  /* Bodziec: typograficzny look */
  .big{
    font-family:'Calibri','Segoe UI',Roboto,sans-serif;
    font-size:92px;
    line-height:1.02;
    font-weight:900;
    letter-spacing:0.5px;
    text-transform:uppercase;
    -webkit-text-stroke:1px rgba(0,0,0,.25);
    text-shadow:0 0 1px rgba(0,0,0,.25);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }
  @media (max-width: 900px){ .big{ font-size:84px; } }
  @media (max-width: 700px){ .big{ font-size:76px; } }
  @media (max-width: 560px){ .big{ font-size:68px; } }

  .fix{font-size:48px;color:#666}
  .btn{background:#2d6cdf;color:#fff;border:none;border-radius:10px;padding:10px 16px;cursor:pointer;font-size:16px}
  .row{margin:18px 0}
  input[type=text]{font-size:18px;padding:8px 10px;border-radius:8px;border:1px solid #999;background:#fff;color:#111;letter-spacing:2px;text-transform:uppercase;text-align:center}

  /* Instrukcja + pigułki klawiszy */
  .keypill{
    display:inline-flex;align-items:center;gap:8px;
    background:#fff;color:#111;border-radius:999px;
    padding:6px 10px;margin:6px;border:1px solid #ccc;
    font-weight:700;box-shadow:0 1px 2px rgba(0,0,0,.06);
  }
  .keypill .k{
    display:inline-block;min-width:28px;text-align:center;
    border:1px solid #bbb;border-radius:6px;padding:2px 6px;
    background:#f3f3f3;font-weight:800;
  }
  .instr-card{
    background:#fff;color:#111;border-radius:16px;padding:18px 20px;
    border:1px solid #ddd;box-shadow:0 2px 8px rgba(0,0,0,.06);
    display:inline-block;text-align:left;
  }
  .instr-card h3{ margin:0 0 10px; font-size:22px }
  .instr-card p{ margin:8px 0 12px }
  .center{ text-align:center }

  /* Karta bodźca */
  .stim-card{
    background:#fff; border:1px solid #ddd; box-shadow:0 4px 18px rgba(0,0,0,.08);
    border-radius:18px; padding:40px 28px; display:inline-block; min-width: min(90vw, 780px);
  }

  /* Wynik – proste pigułki statystyk */
  .stats{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:8px}
  .statpill{
    background:#fff;border:1px solid #ddd;border-radius:12px;
    padding:8px 12px;font-weight:700;box-shadow:0 1px 2px rgba(0,0,0,.06)
  }
</style>
</head>
<body>
<div id="app"></div>

<script>
/* ------- KONFIG ------- */
var CONFIG = {
  TRAIN_N: 10,
  TEST_N: 50,
  MAX_RT: 2000,        /* nieużywane teraz do ucinania, zostawione dla zgodności */
  ITI: 200,
  FIX: 300,
  SAFETY_MS: 15000,    /* miękki limit 15 s na próbę, z możliwością poprawy */
  ENDPOINT_URL: "https://script.google.com/macros/s/AKfycbyX4swWLTPrPlE-fdU6dJjRKkUk7HViz8vj2geAof4TKSsgxvEGFQIEe1hLwMmBkIDS/exec"
};

/* ------- KOLORY ------- */
var COLORS = [
  { word:"CZERWONY",  css:"#D32F2F", key:"c", idx:1 },
  { word:"ZIELONY",   css:"#2E7D32", key:"z", idx:2 },
  { word:"NIEBIESKI", css:"#1565C0", key:"n", idx:3 },
  { word:"FIOLETOWY", css:"#6A1B9A", key:"f", idx:4 },
  { word:"BRĄZOWY",   css:"#6D4C41", key:"b", idx:5 }
];

/* ------- UTIL ------- */
var app = document.getElementById('app');
function sleep(ms){ return new Promise(function(r){ setTimeout(r, ms); }); }
function shuffle(a){ for(var i=a.length-1;i>0;i--){ var j=Math.floor(Math.random()*(i+1)); var t=a[i]; a[i]=a[j]; a[j]=t; } return a; }
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

/* makeTrial: przyjmuje bazowe SŁOWO (baseColor) i opcjonalnie wymuszony ATRAMENT (forcedInkCss) */
function makeTrial(congruent, baseColor, forcedInkCss){
  var color = baseColor || pick(COLORS);
  var word  = color.word;

  var ink, byInk, correct_key, correct_idx, congr;
  if(congruent){
    ink         = color.css;     /* słowo i atrament zgodne */
    byInk       = color;
    correct_key = color.key;
    correct_idx = color.idx;
    congr       = 1;
  } else {
    ink         = forcedInkCss;  /* wymuszamy atrament, żeby balansować INK */
    byInk       = COLORS.find(function(c){ return c.css === ink; });
    correct_key = byInk.key;
    correct_idx = byInk.idx;
    congr       = 0;
  }

  return {
    stim_word: word,
    ink_color: ink,
    congruency: congr,
    correct_key: correct_key,
    correct_idx: correct_idx
  };
}

/* buildTrials: balansuje WORD w kongruentnych i INK w niekongruentnych */
function buildTrials(n){
  var L = COLORS.length;              // 5
  var half = Math.floor(n/2);

  /* === KONGRUENTNE (balans WORD/INK) === */
  var congr_trials = [];
  var congr_rep = Math.floor(half / L);   // pełne cykle po 5
  var congr_rem = half % L;

  for(var r=0; r<congr_rep; r++){
    var cyc = COLORS.slice(0); shuffle(cyc);  // kolejność słów w cyklu
    for(var i=0;i<L;i++){ congr_trials.push(makeTrial(true, cyc[i])); }
  }
  if(congr_rem>0){
    var extraC = COLORS.slice(0); shuffle(extraC);
    for(var e=0;e<congr_rem;e++){ congr_trials.push(makeTrial(true, extraC[e])); }
  }

  /* === NIEKONGRUENTNE (balans INK) === */
  var incong_trials = [];
  var inc_total = n - half;
  var inc_rep = Math.floor(inc_total / L);  // pełne cykle atramentów
  var inc_rem = inc_total % L;

  for(var r2=0; r2<inc_rep; r2++){
    // słowa: po jednym z każdego koloru (kolejność losowa)
    var words = COLORS.slice(0); shuffle(words);
    // atramenty: rotacja listy words -> żadne słowo nie ma własnego koloru
    var shift = (r2 % (L-1)) + 1; // 1..4
    var inks  = words.slice(0).map(function(_,i){ return words[(i+shift)%L].css; });
    for(var j=0;j<L;j++){
      incong_trials.push(makeTrial(false, words[j], inks[j]));
    }
  }
  if(inc_rem>0){
    var wordsRem = COLORS.slice(0); shuffle(wordsRem); wordsRem = wordsRem.slice(0, inc_rem);
    var inksPool = COLORS.slice(0); shuffle(inksPool);
    var usedInks = {};
    for(var t=0; t<wordsRem.length; t++){
      var w = wordsRem[t];
      var chosen = null;
      for(var p=0; p<inksPool.length; p++){
        var cand = inksPool[p].css;
        if(cand !== w.css && !usedInks[cand]){ chosen = cand; usedInks[cand] = true; break; }
      }
      if(!chosen){ // awaryjnie: cokolwiek ≠ słowo
        for(var q=0;q<COLORS.length;q++){ if(COLORS[q].css !== w.css){ chosen = COLORS[q].css; break; } }
      }
      incong_trials.push(makeTrial(false, w, chosen));
    }
  }

  var all = congr_trials.concat(incong_trials);
  shuffle(all);
  return all;
}

/* CSV utils */
function toCSV(rows){
  if(!rows.length) return "no_data\n";
  var header = Object.keys(rows[0]);
  var out = [header.join(",")];
  for(var i=0;i<rows.length;i++){
    var r = rows[i], line = [];
    for(var k=0;k<header.length;k++){
      var h = header[k];
      var v = (r[h]==null ? "" : String(r[h]).replace(/"/g,'""'));
      line.push(/["\n,]/.test(v) ? '"'+v+'"' : v);
    }
    out.push(line.join(","));
  }
  return out.join("\n");
}
function downloadCSV(filename, csv){
  var blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  var a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/* ------- APLIKACJA ------- */
var PID = "";
var LOG = [];

function screenIntro(){
  app.innerHTML =
    '<h2>Badanie Stroopa (PL)</h2>' +
    '<div class="row"><p>Wpisz swoje inicjały (2 litery, np. AK) i naciśnij „Dalej”.</p>' +
    '<input id="pid" type="text" maxlength="2" placeholder="AK" autofocus></div>' +
    '<div class="row"><button class="btn" id="next1">Dalej</button></div>';
  document.getElementById('next1').onclick = function(){
    var v = (document.getElementById('pid').value||"").trim().toUpperCase();
    if(!/^[A-ZĄĆĘŁŃÓŚŹŻ]{2}$/.test(v)){ alert("Podaj dokładnie 2 litery."); return; }
    PID = v;
    screenInstr();
  };
}

function screenInstr(){
  app.innerHTML =
    '<div class="instr-card">' +
      '<h3 class="center">Instrukcja</h3>' +
      '<p class="center"><b>Reaguj na <u>KOLOR CZCIONKI</u></b> (nie na słowo).</p>' +
      '<div class="center" style="margin:10px 0 6px">' +
        '<span class="keypill"><span class="k">C</span><span style="color:#D32F2F">Czerwony</span></span>' +
        '<span class="keypill"><span class="k">Z</span><span style="color:#2E7D32">Zielony</span></span>' +
        '<span class="keypill"><span class="k">N</span><span style="color:#1565C0">Niebieski</span></span>' +
        '<span class="keypill"><span class="k">F</span><span style="color:#6A1B9A">Fioletowy</span></span>' +
        '<span class="keypill"><span class="k">B</span><span style="color:#6D4C41">Brązowy</span></span>' +
      '</div>' +
      '<p class="center muted">' +
        'Najpierw trening (10 prób), potem test (50 prób). Odpowiadaj <b>szybko i poprawnie</b>.' +
        ' Jeśli pomylisz się, możesz <b>od razu nacisnąć właściwy klawisz</b> — liczony jest czas do <b>pierwszej poprawnej</b> odpowiedzi.' +
        ' Dla bezpieczeństwa każda próba ma maks. <b>15 s</b>; po tym czasie liczymy ją jako <i>brak odpowiedzi</i>.' +
      '</p>' +
      '<p class="center" style="color:#b22222;font-weight:700;">⚠️ Upewnij się, że <u>CAPS LOCK jest wyłączony</u>.</p>' +
      '<div class="center" style="margin-top:10px">' +
        '<button class="btn" id="startTrain">Zaczynam trening</button>' +
      '</div>' +
    '</div>';
  document.getElementById('startTrain').onclick = function(){ runBlock("training", CONFIG.TRAIN_N); };
}

async function runBlock(phase, ntrials){
  var trials = buildTrials(ntrials);

  for(var i=0;i<trials.length;i++){
    app.innerHTML = '<div class="fix">+</div>';
    await sleep(CONFIG.FIX);

    var t = trials[i];
    var start = performance.now();
    app.innerHTML = '<div class="stim-card"><div class="big" style="color:'+t.ink_color+';">'+t.stim_word+'</div></div>';

    /* --- reakcja z możliwością poprawy + bezpiecznik 15 s --- */
    var result = await new Promise(function(resolve){
      var errors = 0;      // ile błędnych klawiszy zanim padnie poprawny
      var timer;

      function onKey(e){
        var k = (e.key||"").toLowerCase();
        if(k==="c"||k==="z"||k==="n"||k==="f"||k==="b"){
          if(k !== t.correct_key){ errors++; return; }              // zła -> czekamy na poprawną
          var rt = Math.round(performance.now() - start);           // poprawna -> kończymy próbę
          cleanup();
          resolve({ key:k, status:1, rt:rt, errors:errors });
        }
      }
      function onTimeout(){
        cleanup();
        resolve({ key:"", status:3, rt: CONFIG.SAFETY_MS, errors:errors });
      }
      function cleanup(){
        window.removeEventListener('keydown', onKey);
        clearTimeout(timer);
      }
      window.addEventListener('keydown', onKey);
      timer = setTimeout(onTimeout, CONFIG.SAFETY_MS);
    });

    LOG.push({
      pid: PID,
      phase: phase,
      stim_word: t.stim_word,
      ink_color: t.ink_color,
      congruency: t.congruency,
      correct_key: t.correct_key,
      correct_idx: t.correct_idx,
      key: result.key,
      status: result.status,              // 1=poprawnie (po ewentualnej poprawie), 3=timeout
      rt: result.rt,                      // RT do pierwszej poprawnej (ms) lub 15000 przy timeout
      errors_before_correct: result.errors
    });

    app.innerHTML = '';
    await sleep(CONFIG.ITI);
  }

  if(phase === "training"){
    app.innerHTML =
      '<p>Trening zakończony. Teraz część właściwa ('+CONFIG.TEST_N+' prób).</p>' +
      '<div class="row"><button class="btn" id="startMain">Start testu</button></div>';
    document.getElementById('startMain').onclick = function(){ runBlock("main", CONFIG.TEST_N); };
  } else {
    finish();
  }
}

async function finish(){
  // statystyki z części głównej
  var main = LOG.filter(function(r){ return r.phase==="main"; });
  var total = main.length || 1;

  var nCorrect = main.filter(function(r){ return r.status===1; }).length;           // dotarły do poprawnej
  var nTimeout = main.filter(function(r){ return r.status===3; }).length;           // nie zdążyły w 15 s
  var nWrong   = main.filter(function(r){ return (r.errors_before_correct||0) > 0; }).length; // miały błąd przed poprawną

  function pct(x){ return ((x/total)*100).toFixed(1); }

  var summaryHTML =
    '<div class="instr-card">'+
      '<h3 class="center">Twój wynik</h3>'+
      '<div class="stats">'+
        '<span class="statpill">✅ Poprawne (finalnie): '+pct(nCorrect)+'% <span class="muted">('+nCorrect+'/'+total+')</span></span>'+
        '<span class="statpill">❌ Błędny pierwszy klawisz: '+pct(nWrong)+'% <span class="muted">('+nWrong+'/'+total+')</span></span>'+
        '<span class="statpill">⏱️ Brak odpowiedzi (15 s): '+pct(nTimeout)+'% <span class="muted">('+nTimeout+'/'+total+')</span></span>'+
      '</div>'+
    '</div>';

  // informacja „zapisywanie…”
  app.innerHTML = '<h2>Koniec</h2><p class="muted">Trwa zapisywanie wyników…</p>';

  // próba wysyłki do Google Sheet
  if(CONFIG.ENDPOINT_URL){
    try{
      await fetch(CONFIG.ENDPOINT_URL, {
        method: "POST",
        mode: "no-cors",
        headers: {"Content-Type":"text/plain;charset=utf-8"},
        body: JSON.stringify({ payload: LOG })
      });
      app.innerHTML = summaryHTML + '<p class="muted center" style="margin-top:12px">Dane zostały przesłane — dziękujemy!</p>';
      return;
    }catch(e){}
  }

  // fallback: CSV
  var csv = toCSV(LOG);
  var fname = 'stroop_pl_'+PID+'_'+new Date().toISOString().replace(/[:.]/g,'-')+'.csv';
  downloadCSV(fname, csv);
  app.innerHTML = summaryHTML + '<p class="muted center" style="margin-top:12px">Nie udało się połączyć z serwerem — pobrano plik z wynikami.</p>';
}

/* start */
screenIntro();
</script>
</body>
</html>
